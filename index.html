<html>
<head>
	<style>
		body{
			background:#424446;
		}
		svg {
			width: 1024px;
			height: 768px;
		}
	</style>
</head>
<body>


  <svg id="chart">
  </svg>


<script src="js/vendor/d3.v2.min.js"></script>
<script>
var employees = [];

//Inserting strings at certain indices
//http://stackoverflow.com/questions/4313841/javascript-how-can-i-insert-a-string-at-a-specific-index
String.prototype.insert = function (index, string) {
  if (index > 0)
    return this.substring(0, index) + string + this.substring(index, this.length);
  else
    return string + this;
};

//Employee Class
function Employee(EMAIL,NAME,DATE) {
	var email,name,team,title,start,end;

	this.email = EMAIL;
	this.name = NAME;
	this.start = DATE;
	this.end = DATE;

	// console.log("Created person: "+this.name);
}
Employee.prototype.logInfo = function() {
	console.log(this.name + " started on " + this.start + "and ended on " + this.end + ".");
}

//Retrieve the file list of all the csvs in the data directory, then run a callback on them
function retrieveList(url,callback) {
	d3.csv(url,function(data) {
		callback(data);
	});
}

//Parse a file list, and then update the employee array with the data within
function parseList(filenames) {
	//Only fire the init() function when you've finished running through all of them
	//Shane Berry told me to do it.
	var finishedCounter = 0;
	filenames.forEach(function(d) {
		d3.csv("data/"+d.filename,function(data) {

			//Let's parse the date string (the file name) into a Unix timestamp
			//http://stackoverflow.com/questions/11509814/date-string-conversion-to-unix-timestamp-in-javascript-jquery
			var dateString = (d.filename.substr(0, d.filename.lastIndexOf('.')) || d.filename).insert(4,"-").insert(7,"-").insert(10," 00:00:00");
			var date = Date.parse(dateString);

			updateEmployees(data,date);

			//Is this the last in the series of CSVs? If not, add one and move on. If it is, let's continue!
			if(++finishedCounter>=filenames.length) init();
		});
	});
}

//Input: new list of employees and the date stamp; Update everything in the employee array
function updateEmployees(newEmployees,date) {
	//Ready to go through the list of new employees
	newEmployees.forEach(function(d) {
		//Assume this employee is new until proven otherwise.
		var newEmployee = true;
		for (var i = 0, len = employees.length; i < len; i++) {
			//Is this email already in our array? 
			//If so, they are not new. Let's update their start/end date.
			if(employees[i].email == d.EMAIL) {
				newEmployee = false;
				if(employees[i].start > date) employees[i].start = date;
				else if(employees[i].end < date) employees[i].end = date;
				break;
			}
		}
		//Turns out they are new? Let's add them to our array
		if(newEmployee) employees.push(new Employee(d.EMAIL,d.NAME,date));
	});


}

//Run this
retrieveList("data/list.csv",parseList);

function init() {


    var cx = 100;
    var cy = 0;
    var chartHeight = 768;
    var barWidth = 5;

    //Scaling the duration of employment to the chart height
    var minTime = d3.min(employees, function(d) { return d.end-d.start });
    var maxTime = d3.max(employees, function(d) { return d.end-d.start });
    var rangeScale = d3.scale.linear()
    	.domain([0,maxTime])
    	.range([3,chartHeight]);
    //Scaling the start date to the chart height
    var minStart = d3.min(employees, function(d) { return d.start });
    var maxStart = d3.max(employees, function(d) { return d.start });
	var startScale = d3.scale.linear()
		.domain([0,maxStart-minStart])
		.range([0,chartHeight]);

	//Select the SVG element, append groups
	var svg = d3.select("#chart");
	var bars = svg.selectAll("g.bar")
		.data(employees);
	//Enter the data, apply class, transform it
	var barEnter = bars.enter()
		.append("g")
		.classed("bar",true)
		.attr({
			"transform": 	function(d,i) {
								var x = cx+ i * (barWidth+1);
								var y = startScale(d.start-minStart);
								// console.log(startScale(d.start-minStart));
								return "translate("+[x,y]+")";
							}
		});

	//Append SVG rects to each data point
	barEnter.append("rect")
        .attr("fill", "#F1F2F2")
        .attr("height", 0);
	var rects = bars.select("rect");
	//Set the attributes to reflect the data
	bars.select("rect")
		.attr({
			"width": barWidth,
			"height": 		function(d,i) {
								return rangeScale(d.end-d.start);
							}
		});

}


</script>
<body>
</html>